library(readr)
library(lubridate)
library(askpass)
library(DBI)
library(RPostgres)
library(DBI)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(sf)
library(tibble)
library(purrr)

#Leemos las bases

conteos_semanales_covid_comorbilidades <- read_csv("~/conteos_semanales_covid_comorbilidades.csv")

conteos <- conteos_semanales_covid_comorbilidades %>%  
  separate(`semana_epi_sintomas\tentidad_res\tmunicipio_res\ttipo_paciente\tdefuncion\tobesidad\tdiabetes\thipertension\tn`, 
           into = c("semana_epi_sintomas", "entidad_res", "municipio_res", "tipo_paciente", "defuncion", "obesidad", "diabetes", "hipertension", "n"), 
           sep = "\t")

ensanut <- read_csv("~/R/ensanut_areas_peq.csv")

#Cambiar los números por caracteres 

names(ensanut)[1] <- "cvegeo"
names(conteos)[9] <- "casos"
conteos$obesidad <- gsub(1, "SI", conteos$obesidad)
conteos$obesidad <- gsub(2, "NO", conteos$obesidad)
conteos$obesidad <- gsub(98, "SE IGNORA", conteos$obesidad)
conteos$diabetes <- gsub(1, "SI", conteos$diabetes)
conteos$diabetes <- gsub(2, "NO", conteos$diabetes)
conteos$diabetes <- gsub(98, "SE IGNORA", conteos$diabetes)
conteos$hipertension <- gsub(1, "SI", conteos$hipertension)
conteos$hipertension <- gsub(2, "NO", conteos$hipertension)
conteos$hipertension <- gsub(98, "SE IGNORA", conteos$hipertension)
conteos$tipo_paciente <- gsub(1, "AMBULATORIO", conteos$tipo_paciente)
conteos$tipo_paciente <- gsub(2, "HOSPITALIZADO", conteos$tipo_paciente)
conteos$tipo_paciente <- gsub(99, "NO ESPECIFICADO", conteos$tipo_paciente)

#Mutate para sacar el cvegeo

conteos <- conteos %>% 
  mutate(entidad_res = str_pad(string = entidad_res, 
                               width = 2, 
                               side = "left", pad = 0)) %>%  
  mutate(municipio_res = str_pad(string = conteos$municipio_res, 
                                 width = 3, 
                                 side = "left", pad = 0)) %>% 
  mutate(cvegeo = paste0(entidad_res, municipio_res)) %>% 
  mutate(casos = as.numeric(conteos$casos))

#Se saca el join

conteos <- left_join(conteos, ensanut, by = "cvegeo")

###Sacar la letalidad 

#Datos del CONEVAL
###Le comparto el csv también de los indicadores de pobreza
poblacion <- indicadores_de_pobreza_municipal_2020 %>% 
  mutate(cvegeo = sprintf("%05d", clave_municipio)) %>% 
           select(cvegeo, 1:7)
 
#Letalidad

contagios <- conteos %>% 
  group_by(cvegeo, ent_nom, mun_nom) %>% summarise(contagios = sum(casos))

defunciones <- conteos %>% 
  filter(defuncion == "TRUE") %>% group_by(cvegeo, ent_nom, mun_nom) %>% 
  summarise(defunciones = sum(casos))

letalidad <- left_join(contagios, defunciones)

letalidad <- letalidad %>% mutate (letalidad = round(defunciones/contagios*100, 2)) %>% 
  na.omit()

write_csv(letalidad, "letalidad.csv") 
 
##con obesidad

def_obe <- conteos %>%  filter(obesidad.x== "SI") %>% 
  group_by(cvegeo, ent_nom, mun_nom) %>% filter(defuncion == "TRUE") %>% 
  summarise(defun_obesidad = sum(casos)) %>% na.omit()

def_obe <- left_join(contagios, def_obe) %>% 
  mutate(letalidad = round(defun_obesidad/contagios*100, 2)) %>% 
  na.omit()

write_csv(def_obe, "def_obesidad.csv")

##con diabetes

def_diabe <- conteos %>% 
  filter(diabetes.x== "SI") %>% 
  filter(defuncion == "TRUE") %>% 
  group_by(cvegeo, ent_nom, mun_nom) %>% 
  summarise(defun_diabetes = sum(casos)) %>% na.omit()

def_diabe <- left_join(contagios, den_diabe) %>% 
  mutate(letalidad = round(defun_diabetes/contagios*100, 2)) %>% 
  na.omit()

write_csv(def_diabe, "def_diabetes.csv")

##con hipertension

def_hiperten <- conteos %>% 
  filter(hipertension.x == "SI") %>% 
  filter(defuncion == "TRUE") %>% 
  group_by(cvegeo, ent_nom, mun_nom) %>% 
  summarise(defun_hipertension = sum(casos)) %>% na.omit

def_hiperten <- left_join(contagios, den_hiperten) %>% 
  mutate(letalidad = round(defun_hipertension/contagios*100, 2)) %>% 
  na.omit()

write_csv(def_hiperten, "def_hipertension.csv")

#Prevalencia

prevalencia <- left_join(contagios, poblacion) %>% 
  mutate(prevalencia = round(contagios/poblacion*100, 2)) %>% 
  filter(prevalencia > 1.00) %>% 
  select(1:4, poblacion, prevalencia)

write.csv(prevalencia, "prevalencia.csv")
